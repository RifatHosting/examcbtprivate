<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pofus - Personal Focus</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        // Menggunakan tipografi native Apple untuk nuansa iOS sesungguhnya
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Text"', '"SF Pro Display"', 'system-ui', 'sans-serif'] 
                    },
                    colors: {
                        ios_bg: '#F2F2F7', // Warna background standar iOS
                        ios_card: '#FFFFFF',
                        ios_blue: '#007AFF',
                        ios_blue_dark: '#0056b3',
                        ios_gray: '#8E8E93',
                        ios_gray_light: '#E5E5EA',
                        ios_separator: 'rgba(60, 60, 67, 0.15)',
                    },
                    boxShadow: {
                        'ios': '0 4px 24px rgba(0,0,0,0.04)',
                        'ios-modal': '0 -10px 40px rgba(0,0,0,0.15)',
                    }
                }
            }
        }
    </script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Base & Resets */
        body { background-color: #000; color: #1C1C1E; margin: 0; overscroll-behavior-y: none; -webkit-font-smoothing: antialiased; }
        
        /* App Container (Mobile Mockup on Desktop, Full on Mobile) */
        .app-container { 
            max-width: 430px; /* iPhone Pro Max width */
            margin: 0 auto; 
            background-color: #F2F2F7; 
            height: 100dvh; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 0 10px #000, 0 25px 50px -12px rgba(255,255,255,0.2); 
        }
        @media (max-width: 430px) { .app-container { box-shadow: none; } }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Glassmorphism & Effects */
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .glass-dark { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        
        /* Smooth Interactive Elements */
        .ios-btn { transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.15s; }
        .ios-btn:active { transform: scale(0.96); opacity: 0.8; }
        .ios-list-item { transition: background-color 0.2s; }
        .ios-list-item:active { background-color: #E5E5EA; }

        /* View Transitions */
        .view-section { 
            display: none; flex: 1; overflow-y: auto; padding-bottom: 90px;
            animation: fadeScaleIn 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }
        .view-section.active { display: block; }

        /* Animations */
        @keyframes fadeScaleIn {
            0% { opacity: 0; transform: scale(0.98) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slideUpModal {
            0% { transform: translateY(100%); }
            100% { transform: translateY(0); }
        }
        
        /* Modals (Bottom Sheets) */
        .modal { display: none; align-items: flex-end; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { 
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 24px 24px 0 0;
        }
        .modal.active .modal-content { transform: translateY(0); }

        /* Grouped List iOS Style */
        .inset-grouped { background: #FFF; border-radius: 12px; overflow: hidden; }
        .inset-grouped > div:not(:last-child) { border-bottom: 0.5px solid rgba(60, 60, 67, 0.15); }

        /* Checkbox Custom iOS Style */
        .ios-checkbox-wrapper input:checked + div { background-color: #007AFF; border-color: #007AFF; }
        .ios-checkbox-wrapper input:checked + div i { opacity: 1; }
    </style>
</head>
<body>

<div class="app-container" id="app">

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="absolute top-12 left-1/2 transform -translate-x-1/2 -translate-y-4 opacity-0 pointer-events-none z-[100] transition-all duration-400 ease-out flex items-center gap-3 px-5 py-3 rounded-full shadow-ios glass-dark text-white w-max max-w-[90%]">
        <i id="toast-icon" class="ph-fill ph-info text-xl"></i>
        <span id="toast-msg" class="text-sm font-medium tracking-wide">Pesan toast</span>
    </div>

    <!-- ONBOARDING SCREEN -->
    <div id="onboarding" class="absolute inset-0 bg-white z-50 flex flex-col hidden transition-opacity duration-500">
        <div class="flex-1 flex flex-col px-6 pt-20 pb-10 overflow-y-auto hide-scrollbar">
            <div class="w-20 h-20 bg-blue-50 rounded-3xl flex items-center justify-center mb-6 text-ios_blue shadow-sm">
                <i class="ph-fill ph-leaf text-5xl"></i>
            </div>
            <h1 class="text-3xl font-bold tracking-tight mb-2 text-black">Selamat Datang di Pofus.</h1>
            <p class="text-ios_gray text-[15px] mb-10 leading-relaxed">Fokus pada apa yang penting. Kelola jadwal dan aktivitas Anda dengan pengalaman yang mulus.</p>
            
            <form id="form-onboarding" class="w-full flex-1 flex flex-col space-y-5">
                <!-- Avatar Upload -->
                <div class="flex flex-col items-center mb-4">
                    <label for="ob-avatar" class="relative cursor-pointer group ios-btn">
                        <div id="ob-avatar-preview" class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden object-cover border-[0.5px] border-black/10">
                            <i class="ph-fill ph-camera text-3xl text-gray-300"></i>
                        </div>
                        <div class="absolute inset-0 bg-black/20 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="ph-bold ph-plus text-white text-xl"></i>
                        </div>
                    </label>
                    <input type="file" id="ob-avatar" accept="image/*" class="hidden">
                    <span class="text-xs text-ios_gray mt-3 font-medium">Tambahkan Foto</span>
                </div>
                
                <div class="inset-grouped shadow-sm border border-black/5">
                    <div class="flex items-center px-4 py-1">
                        <label class="w-24 text-[15px] font-medium text-black">Nama</label>
                        <input type="text" id="ob-name" required class="flex-1 py-3 focus:outline-none bg-transparent text-[15px]" placeholder="Nama Lengkap">
                    </div>
                    <div class="flex items-center px-4 py-1">
                        <label class="w-24 text-[15px] font-medium text-black">Lahir</label>
                        <input type="date" id="ob-dob" required class="flex-1 py-3 focus:outline-none bg-transparent text-[15px] text-gray-700">
                    </div>
                </div>
                
                <div class="flex-1"></div> <!-- Spacer -->

                <button type="submit" class="w-full bg-ios_blue text-white font-semibold text-[17px] rounded-2xl px-4 py-4 ios-btn shadow-md">
                    Lanjutkan
                </button>
            </form>
        </div>
    </div>

    <!-- NOTIFICATION PROMPT -->
    <div id="notif-prompt" class="absolute inset-0 z-50 hidden glass-dark items-center justify-center p-5 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl transform scale-95 transition-transform duration-300" id="notif-card">
            <div class="w-16 h-16 bg-blue-50 text-ios_blue rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-fill ph-bell-ringing text-3xl"></i>
            </div>
            <h2 class="text-xl font-bold mb-2 tracking-tight">Izinkan Notifikasi</h2>
            <p class="text-gray-500 text-[15px] mb-8 leading-relaxed">Pofus membutuhkan izin notifikasi agar dapat mengingatkan jadwal dan aktivitas Anda tepat waktu.</p>
            <div class="space-y-3">
                <button id="btn-notif-allow" class="w-full py-3.5 font-semibold text-[17px] text-white bg-ios_blue rounded-2xl ios-btn">Izinkan</button>
                <button id="btn-notif-skip" class="w-full py-3.5 font-medium text-[17px] text-ios_blue bg-blue-50 rounded-2xl ios-btn">Nanti Saja</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP HEADER -->
    <header class="pt-12 pb-2 px-5 bg-[#F2F2F7] sticky top-0 z-20 transition-all duration-300" id="main-header">
        <div class="flex justify-between items-end">
            <div>
                <p id="header-date" class="text-[13px] font-semibold text-ios_gray uppercase tracking-wider mb-0.5">SENIN, 1 JAN</p>
                <h1 id="header-title" class="text-3xl font-bold tracking-tight text-black transition-all duration-300">Hari Ini</h1>
            </div>
            <div class="w-9 h-9 rounded-full bg-gray-200 border border-black/5 overflow-hidden shadow-sm ios-btn cursor-pointer" onclick="switchTab('account')">
                <img id="header-avatar" src="" alt="Profile" class="w-full h-full object-cover hidden">
                <div id="header-avatar-fallback" class="w-full h-full flex items-center justify-center font-semibold text-ios_gray bg-white text-sm">U</div>
            </div>
        </div>
    </header>

    <!-- VIEW: HOME (MONITOR) -->
    <main id="view-home" class="view-section active px-5 hide-scrollbar">
        <!-- Big Clock (iOS Lockscreen style) -->
        <div class="text-center py-6">
            <h2 id="home-clock" class="text-6xl font-semibold tracking-tighter text-black tabular-nums" style="font-family: 'SF Pro Display', system-ui, sans-serif;">00:00</h2>
        </div>

        <!-- Monitor Card -->
        <div id="monitor-card" class="bg-white rounded-[24px] p-5 shadow-ios mb-8 relative overflow-hidden transition-all duration-500 border border-black/5">
            <!-- Blur decor -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-ios_blue opacity-10 rounded-full blur-2xl"></div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <div id="monitor-dot" class="w-2 h-2 rounded-full bg-gray-300"></div>
                        <span id="monitor-badge" class="text-[13px] font-semibold text-gray-500 uppercase tracking-wide">Tidak Ada Sesi</span>
                    </div>
                    <span id="monitor-time" class="text-[13px] font-medium text-gray-400">-</span>
                </div>
                <h3 id="monitor-title" class="text-[22px] font-bold mt-1 mb-5 text-black tracking-tight">Waktu Bebas</h3>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                    <div id="monitor-progress" class="bg-ios_blue h-full rounded-full w-0 transition-all duration-1000 ease-out"></div>
                </div>
                <div class="flex justify-between text-[11px] font-medium mt-2 text-gray-400">
                    <span id="monitor-start">--:--</span>
                    <span id="monitor-end">--:--</span>
                </div>
            </div>
        </div>

        <!-- Today's Schedule -->
        <div class="flex justify-between items-center mb-3 px-1">
            <h3 class="text-xl font-bold tracking-tight text-black">Jadwal</h3>
            <button onclick="openModal('modal-event')" class="w-8 h-8 bg-gray-200/60 text-ios_blue rounded-full flex items-center justify-center ios-btn">
                <i class="ph-bold ph-plus text-lg"></i>
            </button>
        </div>
        
        <div id="schedule-list" class="inset-grouped shadow-sm border border-black/5 mb-6">
            <!-- Event items injected here -->
        </div>
    </main>

    <!-- VIEW: ACTIVITY -->
    <main id="view-activity" class="view-section px-5 hide-scrollbar">
        <!-- Segmented Control -->
        <div class="bg-[#E5E5EA] p-[3px] rounded-xl flex mb-6 relative z-10">
            <button onclick="switchActivityTab('routines')" id="tab-routines" class="flex-1 py-1.5 text-[14px] font-semibold rounded-[9px] bg-white shadow-sm text-black transition-all">Rutinitas</button>
            <button onclick="switchActivityTab('tasks')" id="tab-tasks" class="flex-1 py-1.5 text-[14px] font-medium rounded-[9px] text-gray-500 transition-all">Tugas</button>
        </div>

        <!-- Subview: Routines -->
        <div id="subview-routines" class="space-y-4 pb-6">
            <div class="flex justify-between items-center mb-2 px-1">
                <h3 class="text-xl font-bold tracking-tight text-black">Harian</h3>
                <button onclick="openModal('modal-routine')" class="text-ios_blue ios-btn"><i class="ph-bold ph-plus text-xl"></i></button>
            </div>
            <div id="routines-list" class="inset-grouped shadow-sm border border-black/5"></div>
        </div>

        <!-- Subview: Tasks -->
        <div id="subview-tasks" class="hidden space-y-4 pb-6">
            <div class="flex justify-between items-center mb-2 px-1">
                <select id="task-filter" onchange="renderTasks()" class="text-lg font-bold tracking-tight bg-transparent outline-none text-black appearance-none pr-4">
                    <option value="all">Semua Tugas ‚ñæ</option>
                    <option value="today">Hari Ini ‚ñæ</option>
                    <option value="pending">Tertunda ‚ñæ</option>
                    <option value="done">Selesai ‚ñæ</option>
                </select>
                <button onclick="openModal('modal-task')" class="text-ios_blue ios-btn"><i class="ph-bold ph-plus text-xl"></i></button>
            </div>
            <div id="tasks-list" class="space-y-3"></div>
        </div>
    </main>

    <!-- VIEW: ACCOUNT -->
    <main id="view-account" class="view-section px-5 hide-scrollbar">
        <!-- Profile Header -->
        <div class="flex flex-col items-center mt-4 mb-8 relative">
            <div class="w-24 h-24 rounded-full bg-white shadow-sm border border-black/5 mb-4 overflow-hidden relative group" onclick="openModal('modal-profile')">
                <img id="acc-avatar" src="" alt="Profile" class="w-full h-full object-cover hidden">
                <div id="acc-avatar-fallback" class="w-full h-full flex items-center justify-center text-3xl font-semibold text-ios_gray bg-gray-100">U</div>
                <div class="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 group-active:opacity-100 transition-opacity">
                    <span class="text-white text-xs font-medium bg-black/50 px-2 py-1 rounded-full backdrop-blur-sm">Edit</span>
                </div>
            </div>
            <h2 id="acc-name" class="text-2xl font-bold tracking-tight text-black">Nama User</h2>
            <p id="acc-age" class="text-[15px] text-gray-500 mt-1">-- tahun</p>
        </div>

        <!-- Settings Group -->
        <div class="inset-grouped shadow-sm border border-black/5 mb-6">
            <div class="flex justify-between items-center p-4">
                <div class="flex items-center gap-3.5">
                    <div class="w-7 h-7 rounded-lg bg-red-500 text-white flex items-center justify-center shadow-sm"><i class="ph-fill ph-bell text-[15px]"></i></div>
                    <span class="text-[16px]">Notifikasi</span>
                </div>
                <!-- iOS Toggle Switch -->
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-notif-input" class="sr-only peer">
                    <div class="w-12 h-7 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-[#34C759]"></div>
                </label>
            </div>
            <label class="flex justify-between items-center p-4 ios-list-item cursor-pointer">
                <div class="flex items-center gap-3.5">
                    <div class="w-7 h-7 rounded-lg bg-blue-500 text-white flex items-center justify-center shadow-sm"><i class="ph-bold ph-download-simple text-[15px]"></i></div>
                    <span class="text-[16px]">Import Data</span>
                </div>
                <i class="ph-bold ph-caret-right text-gray-300 text-sm"></i>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
            </label>
            <div class="flex justify-between items-center p-4 ios-list-item cursor-pointer" onclick="exportData()">
                <div class="flex items-center gap-3.5">
                    <div class="w-7 h-7 rounded-lg bg-indigo-500 text-white flex items-center justify-center shadow-sm"><i class="ph-bold ph-upload-simple text-[15px]"></i></div>
                    <span class="text-[16px]">Export Backup</span>
                </div>
                <i class="ph-bold ph-caret-right text-gray-300 text-sm"></i>
            </div>
        </div>

        <div class="inset-grouped shadow-sm border border-black/5">
            <div class="flex justify-between items-center p-4 ios-list-item cursor-pointer" onclick="resetData()">
                <div class="flex items-center gap-3.5">
                    <div class="w-7 h-7 rounded-lg bg-gray-200 text-red-500 flex items-center justify-center shadow-sm"><i class="ph-fill ph-trash text-[15px]"></i></div>
                    <span class="text-[16px] text-red-500">Reset Data</span>
                </div>
            </div>
        </div>
        
        <p class="text-center text-xs text-gray-400 mt-6 font-medium">Pofus v2.0 ‚Ä¢ iOS 26 Design</p>
    </main>

    <!-- BOTTOM TAB BAR (Glassmorphism) -->
    <nav class="absolute bottom-0 w-full glass flex justify-around items-center pb-safe pt-2 pb-6 z-30 border-t border-black/5">
        <button onclick="switchTab('home')" class="nav-btn flex flex-col items-center w-20 text-ios_blue ios-btn">
            <i class="ph-fill ph-house text-[26px] mb-1"></i>
            <span class="text-[10px] font-medium tracking-wide">Hari Ini</span>
        </button>
        <button onclick="switchTab('activity')" class="nav-btn flex flex-col items-center w-20 text-gray-400 ios-btn">
            <i class="ph ph-list-checks text-[26px] mb-1"></i>
            <span class="text-[10px] font-medium tracking-wide">Aktivitas</span>
        </button>
        <button onclick="switchTab('account')" class="nav-btn flex flex-col items-center w-20 text-gray-400 ios-btn">
            <i class="ph ph-user text-[26px] mb-1"></i>
            <span class="text-[10px] font-medium tracking-wide">Akun</span>
        </button>
    </nav>

    <!-- ================= MODALS (BOTTOM SHEETS) ================= -->
    
    <!-- Modal Event -->
    <div id="modal-event" class="modal absolute inset-0 bg-black/40 z-50 backdrop-blur-[2px]">
        <div class="modal-content w-full bg-[#F2F2F7] p-0 h-[85dvh] relative shadow-ios-modal flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 bg-white rounded-t-3xl border-b border-black/5">
                <button onclick="closeModal('modal-event')" class="text-ios_blue font-medium text-[17px] ios-btn">Batal</button>
                <h2 id="event-modal-title" class="text-[17px] font-semibold text-black tracking-tight">Jadwal Baru</h2>
                <button type="submit" form="form-event" class="text-ios_blue font-semibold text-[17px] ios-btn">Simpan</button>
            </div>
            
            <!-- Body -->
            <div class="flex-1 overflow-y-auto px-4 py-6">
                <form id="form-event" class="space-y-6">
                    <input type="hidden" id="ev-id">
                    
                    <div class="inset-grouped">
                        <div class="px-4 py-3">
                            <input type="text" id="ev-title" required class="w-full focus:outline-none bg-transparent text-[17px]" placeholder="Judul Jadwal">
                        </div>
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Kategori</span>
                            <select id="ev-category" class="bg-transparent text-[17px] text-gray-500 outline-none text-right dir-rtl">
                                <option value="study">üìù Belajar</option>
                                <option value="work">üíº Bekerja</option>
                                <option value="rest">‚òï Istirahat</option>
                                <option value="worship">ü§≤ Ibadah</option>
                                <option value="custom">üìå Lainnya</option>
                            </select>
                        </div>
                    </div>

                    <div class="inset-grouped">
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Mulai</span>
                            <input type="time" id="ev-start" required class="bg-gray-100 px-3 py-1.5 rounded-lg text-[17px] outline-none">
                        </div>
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Selesai</span>
                            <input type="time" id="ev-end" required class="bg-gray-100 px-3 py-1.5 rounded-lg text-[17px] outline-none">
                        </div>
                    </div>

                    <div class="inset-grouped">
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Ulangi</span>
                            <select id="ev-recurrence" class="bg-transparent text-[17px] text-gray-500 outline-none text-right">
                                <option value="once">Sekali Saja</option>
                                <option value="daily">Setiap Hari</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" id="btn-del-event" onclick="deleteEvent()" class="hidden w-full inset-grouped px-4 py-3.5 text-center text-[17px] font-semibold text-red-500 ios-btn mt-4">
                        Hapus Jadwal
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Routine -->
    <div id="modal-routine" class="modal absolute inset-0 bg-black/40 z-50 backdrop-blur-[2px]">
        <div class="modal-content w-full bg-[#F2F2F7] p-0 h-[85dvh] relative shadow-ios-modal flex flex-col">
            <div class="flex justify-between items-center p-4 bg-white rounded-t-3xl border-b border-black/5">
                <button onclick="closeModal('modal-routine')" class="text-ios_blue font-medium text-[17px] ios-btn">Batal</button>
                <h2 id="rt-modal-title" class="text-[17px] font-semibold text-black tracking-tight">Rutinitas Baru</h2>
                <button type="submit" form="form-routine" class="text-ios_blue font-semibold text-[17px] ios-btn">Simpan</button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-4 py-6">
                <form id="form-routine" class="space-y-6">
                    <input type="hidden" id="rt-id">
                    
                    <div class="inset-grouped">
                        <div class="px-4 py-3">
                            <input type="text" id="rt-title" required class="w-full focus:outline-none bg-transparent text-[17px]" placeholder="Nama Rutinitas">
                        </div>
                    </div>

                    <div class="inset-grouped">
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Jam <span class="text-gray-400 text-sm">(opsional)</span></span>
                            <input type="time" id="rt-time" class="bg-gray-100 px-3 py-1.5 rounded-lg text-[17px] outline-none text-gray-700">
                        </div>
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Durasi <span class="text-gray-400 text-sm">(mnt)</span></span>
                            <input type="number" id="rt-duration" placeholder="0" class="w-16 text-right bg-transparent text-[17px] outline-none">
                        </div>
                    </div>

                    <div>
                        <span class="block text-xs font-semibold text-gray-500 uppercase ml-4 mb-2">Ulangi Pada Hari</span>
                        <div class="inset-grouped shadow-sm">
                            <div class="flex justify-between px-4 py-3" id="rt-days-container">
                                <!-- Days circles generated via JS -->
                            </div>
                        </div>
                    </div>

                    <button type="button" id="btn-del-routine" onclick="deleteRoutine()" class="hidden w-full inset-grouped px-4 py-3.5 text-center text-[17px] font-semibold text-red-500 ios-btn mt-4">
                        Hapus Rutinitas
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Task -->
    <div id="modal-task" class="modal absolute inset-0 bg-black/40 z-50 backdrop-blur-[2px]">
        <div class="modal-content w-full bg-[#F2F2F7] p-0 h-[85dvh] relative shadow-ios-modal flex flex-col">
            <div class="flex justify-between items-center p-4 bg-white rounded-t-3xl border-b border-black/5">
                <button onclick="closeModal('modal-task')" class="text-ios_blue font-medium text-[17px] ios-btn">Batal</button>
                <h2 id="tk-modal-title" class="text-[17px] font-semibold text-black tracking-tight">Tugas Baru</h2>
                <button type="submit" form="form-task" class="text-ios_blue font-semibold text-[17px] ios-btn">Simpan</button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-4 py-6">
                <form id="form-task" class="space-y-6">
                    <input type="hidden" id="tk-id">
                    
                    <div class="inset-grouped">
                        <div class="px-4 py-3">
                            <input type="text" id="tk-title" required class="w-full focus:outline-none bg-transparent text-[17px]" placeholder="Judul Tugas">
                        </div>
                        <div class="px-4 py-3">
                            <textarea id="tk-desc" rows="3" class="w-full focus:outline-none bg-transparent text-[16px]" placeholder="Deskripsi (Opsional)"></textarea>
                        </div>
                    </div>

                    <div class="inset-grouped">
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Tenggat (Deadline)</span>
                            <input type="date" id="tk-deadline" required class="bg-gray-100 px-3 py-1.5 rounded-lg text-[16px] outline-none">
                        </div>
                    </div>

                    <div class="inset-grouped">
                        <div class="flex justify-between items-center px-4 py-3">
                            <span class="text-[17px] text-black">Prioritas</span>
                            <select id="tk-priority" class="bg-transparent text-[17px] text-gray-500 outline-none text-right">
                                <option value="low">Rendah</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">Penting (!)</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" id="btn-del-task" onclick="deleteTask()" class="hidden w-full inset-grouped px-4 py-3.5 text-center text-[17px] font-semibold text-red-500 ios-btn mt-4">
                        Hapus Tugas
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Edit Profile -->
    <div id="modal-profile" class="modal absolute inset-0 bg-black/40 z-50 backdrop-blur-[2px]">
        <div class="modal-content w-full bg-[#F2F2F7] p-0 h-[70dvh] relative shadow-ios-modal flex flex-col">
            <div class="flex justify-between items-center p-4 bg-white rounded-t-3xl border-b border-black/5">
                <button onclick="closeModal('modal-profile')" class="text-ios_blue font-medium text-[17px] ios-btn">Batal</button>
                <h2 class="text-[17px] font-semibold text-black tracking-tight">Edit Profil</h2>
                <button type="submit" form="form-edit-profile" class="text-ios_blue font-semibold text-[17px] ios-btn">Selesai</button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-4 py-6">
                <form id="form-edit-profile" class="space-y-6">
                    <div class="flex justify-center mb-6">
                        <label for="ep-avatar" class="relative cursor-pointer group ios-btn block">
                            <img id="ep-avatar-preview" class="w-24 h-24 rounded-full bg-gray-100 object-cover border border-black/10">
                            <div class="absolute inset-0 bg-black/30 rounded-full flex flex-col items-center justify-center">
                                <i class="ph-fill ph-camera text-white text-xl"></i>
                                <span class="text-[10px] text-white font-medium mt-1">Edit</span>
                            </div>
                        </label>
                        <input type="file" id="ep-avatar" accept="image/*" class="hidden">
                    </div>

                    <div class="inset-grouped">
                        <div class="flex items-center px-4 py-3">
                            <label class="w-24 text-[17px] text-black">Nama</label>
                            <input type="text" id="ep-name" required class="flex-1 focus:outline-none bg-transparent text-[17px] text-gray-500 text-right">
                        </div>
                        <div class="flex items-center px-4 py-3">
                            <label class="w-24 text-[17px] text-black">Lahir</label>
                            <input type="date" id="ep-dob" required class="flex-1 focus:outline-none bg-transparent text-[17px] text-gray-500 text-right">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<script>
    // --- STATE & UTILS ---
    const DB = {
        profile: 'pofus_profile_v2',
        notif: 'pofus_notif_v2',
        events: 'pofus_schedule_v2',
        routines: 'pofus_routines_v2',
        tasks: 'pofus_tasks_v2',
        seeded: 'pofus_seeded_v2' // Penanda inisialisasi awal (kosong)
    };
    
    let clockInterval;
    const daysArr = ["M", "S", "S", "R", "K", "J", "S"]; // Initial hari (Minggu - Sabtu)
    
    // Setup initial empty state database
    if (!localStorage.getItem(DB.seeded)) {
        localStorage.setItem(DB.events, '[]');
        localStorage.setItem(DB.routines, '[]');
        localStorage.setItem(DB.tasks, '[]');
        localStorage.setItem(DB.seeded, 'true');
    }

    function getEl(id) { return document.getElementById(id); }
    function getVal(id) { return getEl(id).value.trim(); }
    function setVal(id, val) { getEl(id).value = val; }
    function show(id) { getEl(id).classList.remove('hidden'); }
    function hide(id) { getEl(id).classList.add('hidden'); }
    
    function showToast(msg) {
        const toast = getEl('toast');
        getEl('toast-msg').innerText = msg;
        
        // Setup icon
        getEl('toast-icon').className = msg.toLowerCase().includes('hapus') || msg.toLowerCase().includes('batal') || msg.toLowerCase().includes('error') ? 
            'ph-fill ph-warning-circle text-red-400 text-xl' : 'ph-fill ph-check-circle text-green-400 text-xl';

        toast.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-4');
        toast.classList.add('translate-y-0', 'opacity-100');
        
        setTimeout(() => {
            toast.classList.remove('translate-y-0', 'opacity-100');
            toast.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4');
        }, 2500);
    }

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    function getTodayStr() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function timeToMins(timeStr) {
        if(!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        initDaysSelector();
        checkAuth();
        setupImageUploads();
        setupDateHeader();
    });

    function setupDateHeader() {
        const now = new Date();
        const daysFull = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        getEl('header-date').innerText = `${daysFull[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]}`;
    }

    function checkAuth() {
        const profile = localStorage.getItem(DB.profile);
        if (!profile) {
            getEl('onboarding').classList.remove('hidden');
            setTimeout(() => getEl('onboarding').style.opacity = '1', 50);
        } else {
            getEl('onboarding').classList.add('hidden');
            const notifStatus = localStorage.getItem(DB.notif);
            if (!notifStatus) {
                showNotifPrompt();
            } else {
                startApp();
            }
        }
    }

    function showNotifPrompt() {
        const prompt = getEl('notif-prompt');
        prompt.classList.remove('hidden');
        setTimeout(() => {
            prompt.style.opacity = '1';
            getEl('notif-card').classList.remove('scale-95');
            getEl('notif-card').classList.add('scale-100');
        }, 10);
    }

    function hideNotifPrompt() {
        const prompt = getEl('notif-prompt');
        prompt.style.opacity = '0';
        getEl('notif-card').classList.remove('scale-100');
        getEl('notif-card').classList.add('scale-95');
        setTimeout(() => prompt.classList.add('hidden'), 300);
    }

    function startApp() {
        loadProfileHeader();
        switchTab('home');
    }

    // --- ONBOARDING & PROFILE ---
    let tempAvatarBase64 = '';

    function setupImageUploads() {
        getEl('ob-avatar').addEventListener('change', function(e) { handleImage(e, 'ob-avatar-preview'); });
        getEl('ep-avatar').addEventListener('change', function(e) { handleImage(e, 'ep-avatar-preview'); });
    }

    function handleImage(e, previewId) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_SIZE = 200;
                let width = img.width, height = img.height;
                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                
                tempAvatarBase64 = dataUrl;
                const preview = getEl(previewId);
                if(preview.tagName === 'IMG') { preview.src = dataUrl; } 
                else { preview.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`; }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    getEl('form-onboarding').addEventListener('submit', (e) => {
        e.preventDefault();
        const profile = { name: getVal('ob-name'), dob: getVal('ob-dob'), avatar: tempAvatarBase64 };
        localStorage.setItem(DB.profile, JSON.stringify(profile));
        
        getEl('onboarding').style.opacity = '0';
        setTimeout(() => {
            getEl('onboarding').classList.add('hidden');
            showNotifPrompt();
        }, 500);
    });

    // --- NOTIFICATION PERMISSION ---
    getEl('btn-notif-skip').onclick = () => {
        localStorage.setItem(DB.notif, 'skipped');
        hideNotifPrompt();
        startApp();
    };

    getEl('btn-notif-allow').onclick = async () => {
        if (!("Notification" in window)) {
            showToast('Browser tidak mendukung notifikasi');
            localStorage.setItem(DB.notif, 'unsupported');
        } else {
            const permission = await Notification.requestPermission();
            localStorage.setItem(DB.notif, permission);
            if (permission === 'granted') showToast('Notifikasi diaktifkan');
        }
        hideNotifPrompt();
        startApp();
    };

    function updateNotifToggleUI() {
        const toggle = getEl('toggle-notif-input');
        if (Notification.permission === 'granted') {
            toggle.checked = true;
        } else {
            toggle.checked = false;
        }
    }

    getEl('toggle-notif-input').addEventListener('change', async (e) => {
        if (e.target.checked) {
            if (Notification.permission === 'denied') {
                showToast('Izin diblokir browser.');
                e.target.checked = false;
            } else if (Notification.permission === 'default') {
                const perm = await Notification.requestPermission();
                localStorage.setItem(DB.notif, perm);
                e.target.checked = (perm === 'granted');
                if (perm === 'granted') showToast('Notifikasi aktif');
            } else {
                showToast('Notifikasi sudah aktif');
            }
        } else {
            showToast('Nonaktifkan via setelan browser');
            setTimeout(() => e.target.checked = true, 500); // revert visually if they can't turn it off purely via JS
        }
    });

    // --- NAVIGATION LOGIC ---
    function switchTab(tab) {
        // Tab UI styling
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-ios_blue'); btn.classList.add('text-gray-400');
            const icon = btn.querySelector('i');
            icon.className = icon.className.replace('ph-fill', 'ph');
        });
        const activeBtn = document.querySelector(`.nav-btn[onclick="switchTab('${tab}')"]`);
        activeBtn.classList.remove('text-gray-400'); activeBtn.classList.add('text-ios_blue');
        const activeIcon = activeBtn.querySelector('i');
        activeIcon.className = activeIcon.className.replace('ph', 'ph-fill');

        // Header Title Logic
        const titles = { 'home': 'Hari Ini', 'activity': 'Aktivitas', 'account': 'Akun' };
        getEl('header-title').innerText = titles[tab];

        // Views
        document.querySelectorAll('.view-section').forEach(v => {
            v.classList.remove('active');
            v.style.animation = 'none'; // reset animation
        });
        const view = getEl(`view-${tab}`);
        view.classList.add('active');
        setTimeout(() => view.style.animation = '', 10); // trigger animation

        // Logic
        clearInterval(clockInterval);
        if (tab === 'home') { renderHome(); clockInterval = setInterval(updateHomeClock, 1000); }
        if (tab === 'activity') renderActivity();
        if (tab === 'account') renderAccount();
    }

    // --- MODALS (BOTTOM SHEETS) ---
    function openModal(id) { 
        show(id); 
        setTimeout(() => getEl(id).classList.add('active'), 10); 
    }
    function closeModal(id) {
        getEl(id).classList.remove('active');
        setTimeout(() => hide(id), 400); // match transition duration
    }

    // --- HOME & MONITOR ---
    function loadProfileHeader() {
        const p = JSON.parse(localStorage.getItem(DB.profile) || '{}');
        if (p.avatar) {
            getEl('header-avatar').src = p.avatar;
            show('header-avatar'); hide('header-avatar-fallback');
        } else if(p.name) {
            getEl('header-avatar-fallback').innerText = p.name.charAt(0).toUpperCase();
            hide('header-avatar'); show('header-avatar-fallback');
        }
    }

    function updateHomeClock() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        getEl('home-clock').innerText = `${hh}:${mm}`;
        updateMonitorProgress(now);
    }

    let todayEventsCache = [];
    function renderHome() {
        updateHomeClock();
        const allEv = JSON.parse(localStorage.getItem(DB.events) || '[]');
        
        // Filter & Sort
        todayEventsCache = allEv.filter(e => e.recurrence === 'daily' || e.recurrence === 'once')
                                .sort((a,b) => timeToMins(a.startTime) - timeToMins(b.startTime));
        
        const list = getEl('schedule-list');
        if(todayEventsCache.length === 0) {
            // BEAUTIFUL EMPTY STATE FOR IOS DESIGN
            list.innerHTML = `
                <div class="text-center py-12 px-4 flex flex-col items-center">
                    <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4 border border-black/5 shadow-sm">
                        <i class="ph-fill ph-calendar-plus text-2xl text-ios_gray"></i>
                    </div>
                    <h4 class="text-[17px] font-semibold text-black mb-1">Belum Ada Jadwal</h4>
                    <p class="text-[14px] text-gray-500 max-w-[200px]">Buat jadwal pertamamu untuk mulai fokus hari ini.</p>
                </div>
            `;
            list.classList.remove('inset-grouped');
            list.classList.add('bg-white', 'rounded-[16px]');
        } else {
            list.classList.add('inset-grouped');
            list.classList.remove('bg-white', 'rounded-[16px]');
            list.innerHTML = todayEventsCache.map((e, index) => `
                <div onclick="editEvent('${e.id}')" class="p-3.5 flex items-center gap-4 cursor-pointer ios-list-item relative" data-start="${e.startTime}" data-end="${e.endTime}">
                    <div class="w-10 h-10 rounded-full ${getCatColor(e.category)} flex items-center justify-center shrink-0">
                        ${getCatIcon(e.category)}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-black text-[16px]">${e.title}</h4>
                        <p class="text-[13px] text-gray-500 mt-0.5">${e.startTime} - ${e.endTime}</p>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-300"></i>
                </div>
            `).join('');
        }
        updateMonitorProgress(new Date());
    }

    function getCatColor(cat) {
        const map = { 'study':'bg-blue-50 text-ios_blue', 'work':'bg-indigo-50 text-indigo-500', 'rest':'bg-green-50 text-green-500', 'worship':'bg-purple-50 text-purple-500', 'custom':'bg-gray-100 text-gray-600' };
        return map[cat] || 'bg-gray-100 text-gray-600';
    }
    function getCatIcon(cat) {
        const map = { 'study':'<i class="ph-fill ph-book-open"></i>', 'work':'<i class="ph-fill ph-briefcase"></i>', 'rest':'<i class="ph-fill ph-coffee"></i>', 'worship':'<i class="ph-fill ph-hands-praying"></i>', 'custom':'<i class="ph-fill ph-push-pin"></i>' };
        return map[cat] || '<i class="ph-fill ph-push-pin"></i>';
    }

    function updateMonitorProgress(now) {
        const currentMins = now.getHours() * 60 + now.getMinutes();
        let ongoing = null;

        // Reset styling di list
        document.querySelectorAll('#schedule-list .ios-list-item').forEach(el => {
            el.style.backgroundColor = '';
        });

        for (let e of todayEventsCache) {
            const start = timeToMins(e.startTime);
            const end = timeToMins(e.endTime);
            if (currentMins >= start && currentMins < end) {
                ongoing = e;
                // Highlight yg sedang berjalan (subtle gray background)
                const card = document.querySelector(`#schedule-list .ios-list-item[data-start="${e.startTime}"]`);
                if(card) card.style.backgroundColor = '#F2F2F7';
                break;
            }
        }

        const mCard = getEl('monitor-card');
        const mBadge = getEl('monitor-badge');
        const mDot = getEl('monitor-dot');
        const mTime = getEl('monitor-time');
        const mTitle = getEl('monitor-title');
        const mStart = getEl('monitor-start');
        const mEnd = getEl('monitor-end');
        const mProg = getEl('monitor-progress');

        if (ongoing) {
            mCard.style.backgroundColor = '#F0F8FF'; // very subtle blue
            mDot.className = "w-2 h-2 rounded-full bg-ios_blue animate-pulse";
            mBadge.innerText = "Sedang Berlangsung"; mBadge.className = "text-[13px] font-semibold text-ios_blue uppercase tracking-wide";
            mTitle.innerText = ongoing.title;
            mTime.innerText = `${ongoing.startTime} - ${ongoing.endTime}`;
            mStart.innerText = ongoing.startTime; mEnd.innerText = ongoing.endTime;
            
            const startM = timeToMins(ongoing.startTime);
            const endM = timeToMins(ongoing.endTime);
            let pct = ((currentMins - startM) / (endM - startM)) * 100;
            if(pct > 100) pct = 100; if(pct < 0) pct = 0;
            mProg.style.width = `${pct}%`;
        } else {
            mCard.style.backgroundColor = '#FFFFFF';
            mDot.className = "w-2 h-2 rounded-full bg-gray-300";
            mBadge.innerText = "Waktu Bebas"; mBadge.className = "text-[13px] font-semibold text-gray-500 uppercase tracking-wide";
            mTitle.innerText = "Tidak Ada Sesi";
            mTime.innerText = "Sekarang";
            mStart.innerText = ""; mEnd.innerText = "";
            mProg.style.width = `0%`;
        }
    }

    // --- EVENT CRUD ---
    getEl('form-event').addEventListener('submit', (e) => {
        e.preventDefault();
        const start = getVal('ev-start'), end = getVal('ev-end');
        if (timeToMins(start) >= timeToMins(end)) {
            showToast('Waktu tidak valid'); return;
        }

        const evData = {
            id: getVal('ev-id') || generateId(), title: getVal('ev-title'), category: getVal('ev-category'),
            startTime: start, endTime: end, recurrence: getVal('ev-recurrence')
        };

        let evs = JSON.parse(localStorage.getItem(DB.events) || '[]');
        const idx = evs.findIndex(x => x.id === evData.id);
        if (idx >= 0) evs[idx] = evData; else evs.push(evData);
        
        localStorage.setItem(DB.events, JSON.stringify(evs));
        showToast('Jadwal disimpan');
        closeModal('modal-event');
        renderHome();
    });

    function editEvent(id) {
        const evs = JSON.parse(localStorage.getItem(DB.events) || '[]');
        const ev = evs.find(x => x.id === id);
        if(!ev) return;
        
        getEl('event-modal-title').innerText = "Edit Jadwal";
        setVal('ev-id', ev.id); setVal('ev-title', ev.title); setVal('ev-category', ev.category);
        setVal('ev-start', ev.startTime); setVal('ev-end', ev.endTime); setVal('ev-recurrence', ev.recurrence);
        
        show('btn-del-event'); openModal('modal-event');
    }

    function deleteEvent() {
        let evs = JSON.parse(localStorage.getItem(DB.events) || '[]');
        evs = evs.filter(x => x.id !== getVal('ev-id'));
        localStorage.setItem(DB.events, JSON.stringify(evs));
        showToast('Jadwal dihapus');
        closeModal('modal-event'); renderHome();
    }

    document.querySelector('button[onclick="openModal(\'modal-event\')"]').addEventListener('click', () => {
        getEl('form-event').reset(); setVal('ev-id', '');
        getEl('event-modal-title').innerText = "Jadwal Baru";
        hide('btn-del-event');
    });

    // --- ACTIVITY (ROUTINES & TASKS) ---
    function switchActivityTab(tab) {
        if(tab === 'routines') {
            getEl('tab-routines').className = "flex-1 py-1.5 text-[14px] font-semibold rounded-[9px] bg-white shadow-sm text-black transition-all";
            getEl('tab-tasks').className = "flex-1 py-1.5 text-[14px] font-medium rounded-[9px] text-gray-500 transition-all";
            show('subview-routines'); hide('subview-tasks'); renderRoutines();
        } else {
            getEl('tab-tasks').className = "flex-1 py-1.5 text-[14px] font-semibold rounded-[9px] bg-white shadow-sm text-black transition-all";
            getEl('tab-routines').className = "flex-1 py-1.5 text-[14px] font-medium rounded-[9px] text-gray-500 transition-all";
            show('subview-tasks'); hide('subview-routines'); renderTasks();
        }
    }

    function renderActivity() {
        if(!getEl('subview-tasks').classList.contains('hidden')) renderTasks();
        else renderRoutines();
    }

    // --- ROUTINES CRUD ---
    function initDaysSelector() {
        const container = getEl('rt-days-container');
        container.innerHTML = daysArr.map((d, i) => `
            <label class="cursor-pointer relative group">
                <input type="checkbox" class="peer hidden rt-day-cb" value="${i}">
                <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 font-semibold text-[13px] flex items-center justify-center transition-colors peer-checked:bg-ios_blue peer-checked:text-white">${d}</div>
            </label>
        `).join('');
    }

    function renderRoutines() {
        const todayDay = new Date().getDay();
        const rts = JSON.parse(localStorage.getItem(DB.routines) || '[]');
        const todayRts = rts.filter(r => r.days.length === 0 || r.days.includes(todayDay));
        const list = getEl('routines-list');
        
        if(todayRts.length === 0) {
            list.innerHTML = `
                <div class="text-center py-10 px-4">
                    <div class="w-14 h-14 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3 border border-black/5">
                        <i class="ph-fill ph-arrows-clockwise text-xl text-gray-400"></i>
                    </div>
                    <p class="text-[14px] text-gray-500">Tidak ada rutinitas untuk hari ini.</p>
                </div>`;
            return;
        }

        list.innerHTML = todayRts.map(r => {
            const isDone = r.lastDone === getTodayStr();
            return `
            <div class="p-4 flex items-center gap-4 ios-list-item transition">
                <label class="ios-checkbox-wrapper flex items-center cursor-pointer">
                    <input type="checkbox" class="hidden" ${isDone ? 'checked' : ''} onchange="toggleRoutine('${r.id}', this.checked)">
                    <div class="w-6 h-6 rounded-full border-[1.5px] border-gray-300 flex items-center justify-center transition-colors">
                        <i class="ph-bold ph-check text-white text-[12px] opacity-0 transition-opacity"></i>
                    </div>
                </label>
                <div class="flex-1 cursor-pointer" onclick="editRoutine('${r.id}')">
                    <h4 class="font-medium text-[16px] ${isDone ? 'text-gray-400 line-through' : 'text-black'}">${r.title}</h4>
                    <p class="text-[13px] text-gray-400 mt-0.5">${r.time ? r.time : 'Sepanjang hari'}${r.duration ? ` ‚Ä¢ ${r.duration} mnt` : ''}</p>
                </div>
            </div>`;
        }).join('');
    }

    function toggleRoutine(id, checked) {
        let rts = JSON.parse(localStorage.getItem(DB.routines) || '[]');
        const idx = rts.findIndex(x => x.id === id);
        if(idx >= 0) {
            rts[idx].lastDone = checked ? getTodayStr() : '';
            localStorage.setItem(DB.routines, JSON.stringify(rts));
            renderRoutines();
        }
    }

    getEl('form-routine').addEventListener('submit', (e) => {
        e.preventDefault();
        const days = Array.from(document.querySelectorAll('.rt-day-cb:checked')).map(cb => parseInt(cb.value));
        const id = getVal('rt-id') || generateId();
        
        let rts = JSON.parse(localStorage.getItem(DB.routines) || '[]');
        const idx = rts.findIndex(x => x.id === id);
        
        const rtData = {
            id, title: getVal('rt-title'), time: getVal('rt-time'),
            duration: getVal('rt-duration'), days, lastDone: idx >= 0 ? rts[idx].lastDone : ''
        };

        if (idx >= 0) rts[idx] = rtData; else rts.push(rtData);
        localStorage.setItem(DB.routines, JSON.stringify(rts));
        showToast('Rutinitas disimpan'); closeModal('modal-routine'); renderRoutines();
    });

    function editRoutine(id) {
        const rts = JSON.parse(localStorage.getItem(DB.routines) || '[]');
        const rt = rts.find(x => x.id === id);
        if(!rt) return;
        
        getEl('rt-modal-title').innerText = "Edit Rutinitas";
        setVal('rt-id', rt.id); setVal('rt-title', rt.title); 
        setVal('rt-time', rt.time); setVal('rt-duration', rt.duration);
        document.querySelectorAll('.rt-day-cb').forEach(cb => cb.checked = rt.days.includes(parseInt(cb.value)));
        
        show('btn-del-routine'); openModal('modal-routine');
    }

    function deleteRoutine() {
        let rts = JSON.parse(localStorage.getItem(DB.routines) || '[]');
        rts = rts.filter(x => x.id !== getVal('rt-id'));
        localStorage.setItem(DB.routines, JSON.stringify(rts));
        showToast('Rutinitas dihapus'); closeModal('modal-routine'); renderRoutines();
    }

    document.querySelector('button[onclick="openModal(\'modal-routine\')"]').addEventListener('click', () => {
        getEl('form-routine').reset(); setVal('rt-id', '');
        getEl('rt-modal-title').innerText = "Rutinitas Baru";
        document.querySelectorAll('.rt-day-cb').forEach(cb => cb.checked = false);
        hide('btn-del-routine');
    });

    // --- TASKS CRUD ---
    function renderTasks() {
        const filter = getVal('task-filter');
        let tks = JSON.parse(localStorage.getItem(DB.tasks) || '[]');
        const todayStr = getTodayStr();
        
        if (filter === 'today') tks = tks.filter(t => t.deadline === todayStr);
        else if (filter === 'pending') tks = tks.filter(t => t.status !== 'done');
        else if (filter === 'done') tks = tks.filter(t => t.status === 'done');
        
        const pScore = { 'high':3, 'normal':2, 'low':1 };
        tks.sort((a,b) => {
            if(a.status !== b.status) return a.status === 'done' ? 1 : -1;
            if(a.deadline !== b.deadline) return a.deadline.localeCompare(b.deadline);
            return pScore[b.priority] - pScore[a.priority];
        });

        const list = getEl('tasks-list');
        if(tks.length === 0) {
            list.innerHTML = `
                <div class="text-center py-10 px-4 bg-white rounded-[16px] shadow-sm border border-black/5 mt-2">
                    <div class="w-14 h-14 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3 border border-black/5">
                        <i class="ph-fill ph-check-circle text-xl text-gray-400"></i>
                    </div>
                    <p class="text-[14px] text-gray-500">Semua tugas telah selesai.</p>
                </div>`;
            return;
        }

        list.innerHTML = tks.map(t => {
            const isDone = t.status === 'done';
            const prioIcon = t.priority === 'high' ? '<span class="text-red-500 font-bold mr-1">!</span>' : '';
            return `
            <div class="bg-white rounded-xl shadow-sm border border-black/5 p-4 flex gap-3 ios-btn">
                <div class="pt-0.5">
                    <label class="ios-checkbox-wrapper flex items-center cursor-pointer">
                        <input type="checkbox" class="hidden" ${isDone ? 'checked' : ''} onchange="toggleTaskStatus('${t.id}', this.checked)">
                        <div class="w-6 h-6 rounded-full border-[1.5px] border-gray-300 flex items-center justify-center transition-colors">
                            <i class="ph-bold ph-check text-white text-[12px] opacity-0 transition-opacity"></i>
                        </div>
                    </label>
                </div>
                <div class="flex-1 cursor-pointer" onclick="editTask('${t.id}')">
                    <h4 class="font-medium text-[16px] mb-0.5 ${isDone ? 'line-through text-gray-400' : 'text-black'}">${prioIcon}${t.title}</h4>
                    ${t.desc ? `<p class="text-[13px] text-gray-500 mb-1.5 line-clamp-1">${t.desc}</p>` : ''}
                    <div class="text-[12px] font-medium text-gray-400 flex items-center gap-1">
                        <i class="ph-fill ph-calendar-blank"></i> ${t.deadline.split('-').reverse().join('/')}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function toggleTaskStatus(id, checked) {
        let tks = JSON.parse(localStorage.getItem(DB.tasks) || '[]');
        const idx = tks.findIndex(x => x.id === id);
        if(idx >= 0) {
            tks[idx].status = checked ? 'done' : 'todo';
            localStorage.setItem(DB.tasks, JSON.stringify(tks));
            renderTasks();
        }
    }

    getEl('form-task').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = getVal('tk-id') || generateId();
        const tkData = {
            id, title: getVal('tk-title'), desc: getVal('tk-desc'),
            deadline: getVal('tk-deadline'), priority: getVal('tk-priority'), 
            status: 'todo'
        };

        let tks = JSON.parse(localStorage.getItem(DB.tasks) || '[]');
        const idx = tks.findIndex(x => x.id === id);
        if (idx >= 0) {
            tkData.status = tks[idx].status; // preserve status
            tks[idx] = tkData;
        } else tks.push(tkData);
        
        localStorage.setItem(DB.tasks, JSON.stringify(tks));
        showToast('Tugas disimpan'); closeModal('modal-task'); renderTasks();
    });

    function editTask(id) {
        const tks = JSON.parse(localStorage.getItem(DB.tasks) || '[]');
        const tk = tks.find(x => x.id === id);
        if(!tk) return;
        
        getEl('tk-modal-title').innerText = "Edit Tugas";
        setVal('tk-id', tk.id); setVal('tk-title', tk.title); setVal('tk-desc', tk.desc);
        setVal('tk-deadline', tk.deadline); setVal('tk-priority', tk.priority);
        
        show('btn-del-task'); openModal('modal-task');
    }

    function deleteTask() {
        let tks = JSON.parse(localStorage.getItem(DB.tasks) || '[]');
        tks = tks.filter(x => x.id !== getVal('tk-id'));
        localStorage.setItem(DB.tasks, JSON.stringify(tks));
        showToast('Tugas dihapus'); closeModal('modal-task'); renderTasks();
    }

    document.querySelector('button[onclick="openModal(\'modal-task\')"]').addEventListener('click', () => {
        getEl('form-task').reset(); setVal('tk-id', '');
        getEl('tk-modal-title').innerText = "Tugas Baru";
        setVal('tk-deadline', getTodayStr());
        hide('btn-del-task');
    });

    // --- ACCOUNT & SETTINGS ---
    function renderAccount() {
        const p = JSON.parse(localStorage.getItem(DB.profile) || '{}');
        getEl('acc-name').innerText = p.name || 'User';
        
        if (p.dob) {
            const bdate = new Date(p.dob);
            const diff = Date.now() - bdate.getTime();
            const age = Math.abs(new Date(diff).getUTCFullYear() - 1970);
            getEl('acc-age').innerText = `${age} tahun`;
        }

        if(p.avatar) {
            getEl('acc-avatar').src = p.avatar; show('acc-avatar'); hide('acc-avatar-fallback');
        } else {
            getEl('acc-avatar-fallback').innerText = (p.name || 'U').charAt(0).toUpperCase();
            hide('acc-avatar'); show('acc-avatar-fallback');
        }
        updateNotifToggleUI();
    }

    // Edit Profile Logic
    document.querySelector('.group').addEventListener('click', () => {
        const p = JSON.parse(localStorage.getItem(DB.profile) || '{}');
        setVal('ep-name', p.name || ''); setVal('ep-dob', p.dob || '');
        tempAvatarBase64 = p.avatar || '';
        if(p.avatar) getEl('ep-avatar-preview').src = p.avatar;
    });

    getEl('form-edit-profile').addEventListener('submit', (e) => {
        e.preventDefault();
        const p = { name: getVal('ep-name'), dob: getVal('ep-dob'), avatar: tempAvatarBase64 };
        localStorage.setItem(DB.profile, JSON.stringify(p));
        showToast('Profil diperbarui'); closeModal('modal-profile');
        renderAccount(); loadProfileHeader();
    });

    // Import / Export Data
    function exportData() {
        const data = {};
        Object.keys(DB).forEach(key => {
            const val = localStorage.getItem(DB[key]);
            if(val) data[DB[key]] = val;
        });
        
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const url  = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pofus_backup_${getTodayStr()}.json`;
        a.click(); URL.revokeObjectURL(url);
        showToast('Data berhasil diexport');
    }

    function importData(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const data = JSON.parse(evt.target.result);
                if(!data[DB.profile]) throw new Error("Format tidak valid");
                Object.keys(data).forEach(key => localStorage.setItem(key, data[key]));
                showToast('Data berhasil diimport');
                setTimeout(() => location.reload(), 1000);
            } catch(err) {
                showToast('Gagal memuat file JSON');
            }
        };
        reader.readAsText(file);
    }

    function resetData() {
        if(confirm("Yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan.")) {
            localStorage.clear();
            location.reload();
        }
    }

</script>
</body>
                                                                                                                                           </html
