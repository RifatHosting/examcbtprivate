<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureExam - Ujian Online</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Style kustom untuk font dan beberapa override jika diperlukan */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        /* Menyembunyikan spinner pada input number */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            border-top-color: #111827; /* gray-900 */
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- Header (Tampil setelah login) -->
    <header id="header" class="bg-white shadow-md sticky top-0 z-50 hidden">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-900">SecureExam</div>
            <div id="userInfo" class="hidden items-center gap-3">
                <div id="userAvatar" class="w-10 h-10 rounded-full bg-gray-800 text-white flex items-center justify-center font-semibold">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <div id="userName" class="font-semibold text-sm sm:text-base">Nama Siswa</div>
                    <div id="userRole" class="text-xs sm:text-sm text-gray-600">Siswa</div>
                </div>
                <button id="logoutBtn" class="ml-2 sm:ml-4 bg-red-600 hover:bg-red-700 text-white py-2 px-3 sm:px-4 rounded-lg text-sm font-medium transition duration-200 flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="hidden sm:inline">Keluar</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Konten Utama -->
    <main id="app-container">

        <!-- Login Section -->
        <section id="loginSection" class="section active min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-4xl bg-white rounded-xl shadow-xl overflow-hidden md:flex">
                <!-- Bagian Kiri (Info) - HIDDEN DI HP, TAMPIL DI MD KE ATAS -->
                <div class="hidden md:flex w-1/2 bg-gray-900 text-white p-8 md:p-12 flex-col justify-center">
                    <h1 class="text-3xl lg:text-4xl font-bold mb-3">SecureExam</h1>
                    <p class="text-lg text-gray-300 mb-6">Platform Ujian Online Aman dan Terintegrasi.</p>
                    <p class="text-gray-400">Pastikan Anda menggunakan browser yang didukung dan koneksi internet stabil. Dilarang membuka tab lain atau aplikasi lain selama ujian berlangsung.</p>
                </div>
                
                <!-- Bagian Kanan (Form Login) - FULL WIDTH DI HP, 1/2 DI MD KE ATAS -->
                <div class="w-full md:w-1/2 p-8 md:p-12">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Login Siswa</h2>
                    <p class="text-gray-600 mb-6">Masukkan kredensial Anda untuk memulai ujian.</p>
                    
                    <div id="loginAlert"></div>
                    
                    <form id="loginForm" class="space-y-5">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="username" name="username" placeholder="Masukkan username" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" name="password" placeholder="Masukkan password" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent">
                        </div>
                        <button type="submit" class="w-full bg-gray-900 hover:bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold text-lg transition duration-200 flex items-center justify-center gap-2">
                            <span id="loginButtonText">Masuk</span>
                            <div id="loginSpinner" class="loading hidden"></div>
                        </button>
                    </form>
                    <div class="mt-6 text-center text-gray-600 text-sm">
                        <p>Demo Siswa: siswa1 / password123 (Kelas: 10A)</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Student Dashboard Section -->
        <section id="studentDashboardSection" class="section hidden max-w-5xl mx-auto p-4 md:p-8">
            <div class="dashboard-header mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1">Dashboard Siswa</h1>
                <p class="text-gray-600">Pilih ujian yang tersedia untuk Anda.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="stat-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-gray-800">
                    <div class="text-4xl sm:text-5xl font-bold text-gray-900" id="studentTotalExams">0</div>
                    <div class="text-base sm:text-lg text-gray-600">Ujian Tersedia</div>
                </div>
                <div class="stat-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-600">
                    <div class="text-4xl sm:text-5xl font-bold text-gray-900" id="studentCompletedExams">0</div>
                    <div class="text-base sm:text-lg text-gray-600">Ujian Selesai</div>
                </div>
            </div>

            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">Ujian Tersedia</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div id="availableExams" class="divide-y divide-gray-200">
                    <!-- Exam list populated by JS -->
                </div>
            </div>
            
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mt-10 mb-4">Riwayat Ujian</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="table-container overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 sm:p-4 text-left text-sm font-semibold text-gray-600 uppercase">Ujian</th>
                                <th class="p-3 sm:p-4 text-left text-sm font-semibold text-gray-600 uppercase">Tanggal</th>
                                <th class="p-3 sm:p-4 text-left text-sm font-semibold text-gray-600 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="studentHistoryTableBody" class="divide-y divide-gray-200">
                            <!-- History rows populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Exam Section -->
        <section id="examSection" class="section hidden">
            <!-- Header Ujian -->
            <div class="bg-gray-900 text-white sticky top-[68px] z-40 shadow-lg">
                <!-- 68px adalah tinggi header utama -->
                <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
                    <div class="text-center md:text-left">
                        <h1 class="text-xl sm:text-2xl font-bold" id="examTitle">Judul Ujian</h1>
                        <p class="text-gray-300 text-sm sm:text-base" id="examSubtitle">Subjudul Ujian</p>
                    </div>
                    <div class="mt-3 md:mt-0 bg-red-600 px-4 py-2 rounded-lg text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-clock"></i>
                        <span id="timerDisplay">60:00</span>
                    </div>
                </div>
            </div>

            <!-- Konten Ujian -->
            <div class="max-w-5xl mx-auto p-4 md:p-8 mt-6">
                <!-- Kontainer Soal -->
                <div class="bg-white p-5 sm:p-6 md:p-8 rounded-xl shadow-xl">
                    <div class="question-header mb-5 flex justify-between items-center">
                        <span class="question-number bg-gray-800 text-white px-4 py-1 rounded-full text-sm font-semibold" id="questionNumber">Pertanyaan 1</span>
                        <span class="question-points text-gray-600 text-sm font-medium" id="questionPoints">5 poin</span>
                    </div>
                    <!-- Teks Soal -->
                    <div id="questionText" class="text-base sm:text-lg text-gray-800 mb-6 leading-relaxed">
                        Ini adalah contoh pertanyaan. Mana jawaban yang benar?
                    </div>
                    <!-- Opsi Jawaban -->
                    <div class="options-container space-y-3" id="optionsContainer">
                        <!-- Opsi populated by JS -->
                    </div>
                </div>

                <!-- Navigasi Soal -->
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-xl mt-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Navigasi Soal</h3>
                    <div class="question-navigation flex flex-wrap gap-2 mb-6" id="questionNavigation">
                        <!-- Nav buttons populated by JS -->
                    </div>
                    
                    <!-- Tombol Aksi -->
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <button id="prevQuestionBtn" disabled
                                class="w-full md:w-auto bg-gray-300 text-gray-700 py-3 px-6 rounded-lg font-semibold transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left"></i> Sebelumnya
                        </button>
                        <button id="nextQuestionBtn"
                                class="w-full md:w-auto bg-gray-900 hover:bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-200 flex items-center justify-center gap-2">
                            Selanjutnya <i class="fas fa-chevron-right"></i>
                        </button>
                        <button id="submitExamBtn" style="display: none;"
                                class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-200 flex items-center justify-center gap-2">
                            <i class="fas fa-paper-plane"></i> Kirim Ujian
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Exam Finished Section (Pengganti Halaman Nilai) -->
        <section id="examFinishedSection" class="section hidden min-h-[calc(100vh-68px)] flex items-center justify-center p-4">
            <div class="bg-white p-10 md:p-16 rounded-xl shadow-xl text-center max-w-lg">
                <div class="text-6xl text-green-500 mb-6">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-3">Ujian Selesai</h1>
                <p class="text-gray-600 text-base sm:text-lg mb-8">Jawaban Anda telah berhasil dikirimkan. Terima kasih telah mengikuti ujian.</p>
                <button id="backToDashboardBtn" class="w-full bg-gray-900 hover:bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold text-lg transition duration-200 flex items-center justify-center gap-2">
                    <i class="fas fa-home"></i> Kembali ke Dashboard
                </button>
            </div>
        </section>

        <!-- Ban Section -->
        <section id="banSection" class="section hidden min-h-[calc(100vh-68px)] flex items-center justify-center p-4">
            <div class="bg-white p-10 md:p-16 rounded-xl shadow-xl text-center max-w-lg">
                <div class="text-6xl text-red-600 mb-6">
                    <i class="fas fa-ban"></i>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-3">Akun Diblokir</h1>
                <p class="text-gray-600 text-base sm:text-lg mb-6">Akun Anda telah diblokir karena terdeteksi melakukan pelanggaran. Masukkan kode token dari pengawas untuk membuka blokir.</p>
                
                <div id="banAlert"></div>
                <form id="unlockForm" class="space-y-4">
                    <div class="form-group">
                        <label for="unlockCode" class="sr-only">Kode Token</label>
                        <input type="text" id="unlockCode" placeholder="Masukkan kode token" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-lg focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-gray-900 hover:bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold text-lg transition duration-200 flex items-center justify-center gap-2">
                        <i class="fas fa-unlock"></i> Buka Blokir
                    </button>
                </form>
                <div class="mt-4 text-sm text-gray-500">
                    <p>Demo kode buka blokir: UNLOCK123</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal Konfirmasi Kirim Ujian -->
    <div id="confirmSubmitModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Kirim Ujian?</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin mengirim ujian? Anda tidak dapat mengubah jawaban setelah ini.</p>
            <div id="confirmSubmitAlert"></div>
            <div class_name="flex justify-end gap-3">
                <button id="cancelSubmitBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-5 rounded-lg font-semibold transition duration-200">Batal</button>
                <button id="confirmSubmitBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-5 rounded-lg font-semibold transition duration-200">Ya, Kirim</button>
            </div>
        </div>
    </div>

    <!-- Peringatan Pelanggaran -->
    <div id="violationWarning" class="fixed inset-0 bg-black bg-opacity-90 z-[9998] flex items-center justify-center p-4 text-center text-white hidden">
        <div>
            <div class="text-7xl sm:text-8xl text-red-500 mb-6">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="text-3xl sm:text-4xl font-bold mb-4">PELANGGARAN TERDETEKSI</h2>
            <p class="text-lg sm:text-xl text-gray-300 mb-2" id="violationReason">Anda mencoba beralih dari halaman ujian.</p>
            <p class="text-lg sm:text-xl text-gray-300 mb-8">Tindakan ini dilarang dan akan dicatat.</p>
            <p class="text-2xl sm:text-3xl font-bold mb-4">Pelanggaran: <span id="violationCount">1</span> / 3</p>
            <p class="text-base sm:text-lg">Harap fokus kembali ke ujian. Anda akan diblokir jika melakukan 3x pelanggaran.</p>
        </div>
    </div>


    <script>
        // Application State
        const appState = {
            currentUser: null,
            currentExam: null, // Berisi objek ujian yang sedang dikerjakan
            currentQuestion: 0,
            examAnswers: {},
            violations: 0,
            examTimer: null,
            examStartTime: null,
            // Database (akan disinkronkan dengan localStorage)
            users: [],
            exams: [],
            results: []
        };

        // DOM Elements
        const sections = {
            login: document.getElementById('loginSection'),
            studentDashboard: document.getElementById('studentDashboardSection'),
            exam: document.getElementById('examSection'),
            examFinished: document.getElementById('examFinishedSection'),
            ban: document.getElementById('banSection')
        };
        const header = document.getElementById('header');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const violationWarning = document.getElementById('violationWarning');
        const confirmSubmitModal = document.getElementById('confirmSubmitModal');

        // --- Database (LocalStorage) Functions ---
        
        function initializeData() {
            // Load users
            const savedUsers = localStorage.getItem('examUsers');
            if (savedUsers) {
                appState.users = JSON.parse(savedUsers);
            } else {
                // Data demo jika localStorage kosong
                appState.users = [
                    { id: 1, username: 'admin', password: 'admin123', fullName: 'Administrator', role: 'admin', classId: null },
                    { id: 2, username: 'siswa1', password: 'password123', fullName: 'Siswa Satu', role: 'siswa', classId: '10A' },
                    { id: 3, username: 'siswa2', password: 'password123', fullName: 'Siswa Dua', role: 'siswa', classId: '10B' }
                ];
                saveUsersToStorage();
            }

            // Load exams
            const savedExams = localStorage.getItem('examExams');
            if (savedExams) {
                appState.exams = JSON.parse(savedExams);
            } else {
                appState.exams = [
                    {
                        id: 1,
                        name: 'Ujian Matematika Dasar',
                        subject: 'Matematika',
                        duration: 60, // dalam menit
                        assignedClasses: [], // Awalnya kosong, di-assign oleh admin
                        questions: [
                            {
                                id: 1,
                                question: 'Berapa hasil dari 15 + 25?',
                                options: ['30', '35', '40', '45'],
                                correctAnswer: 2, // index 2 (40)
                                points: 5
                            },
                            {
                                id: 2,
                                question: 'Berapa hasil dari 7 Ã— 8?',
                                options: ['48', '54', '56', '64'],
                                correctAnswer: 2, // index 2 (56)
                                points: 5
                            }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Ujian Bahasa Indonesia',
                        subject: 'Bahasa Indonesia',
                        duration: 45,
                        assignedClasses: [], // Awalnya kosong
                        questions: [
                            {
                                id: 1,
                                question: 'Manakah yang bukan merupakan kata kerja?',
                                options: ['Berlari', 'Membaca', 'Meja', 'Menulis'],
                                correctAnswer: 2, // index 2 (Meja)
                                points: 5
                            }
                        ]
                    }
                ];
                saveExamsToStorage();
            }

            // Load results
            const savedResults = localStorage.getItem('examResults');
            if (savedResults) {
                appState.results = JSON.parse(savedResults);
            } else {
                appState.results = [];
                saveResultsToStorage();
            }
        }

        function saveUsersToStorage() {
            localStorage.setItem('examUsers', JSON.stringify(appState.users));
        }

        function saveExamsToStorage() {
            localStorage.setItem('examExams', JSON.stringify(appState.exams));
        }

        function saveResultsToStorage() {
            localStorage.setItem('examResults', JSON.stringify(appState.results));
        }

        // --- Utility Functions ---

        function showSection(sectionName) {
            Object.keys(sections).forEach(key => {
                sections[key].classList.add('hidden');
                sections[key].classList.remove('active');
            });
            if (sections[sectionName]) {
                sections[sectionName].classList.remove('hidden');
                sections[sectionName].classList.add('active');
            }
            
            if (sectionName === 'login') {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
            }
        }

        function showAlert(containerId, message, type = 'danger') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const colors = {
                danger: 'bg-red-100 border-red-500 text-red-700',
                success: 'bg-green-100 border-green-500 text-green-700'
            };
            
            container.innerHTML = `
                <div class="p-4 border-l-4 ${colors[type]}" role="alert">
                    <p class="font-bold">${type === 'danger' ? 'Error' : 'Sukses'}</p>
                    <p>${message}</p>
                </div>
            `;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
            
            // Check for saved session
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                appState.currentUser = JSON.parse(savedUser);
                
                // Cek apakah user ini di-ban
                if (localStorage.getItem('bannedUser_' + appState.currentUser.id) === 'true') {
                    showSection('ban');
                    updateUserInfo();
                } else if (appState.currentUser.role === 'admin') {
                    // Admin tidak boleh login di halaman siswa
                    logout(); // Langsung logout jika terdeteksi admin
                } else {
                    updateUserInfo();
                    showSection('studentDashboard');
                    loadStudentDashboard();
                }
            } else {
                showSection('login');
            }
        });

        // --- Authentication (Login/Logout) ---

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');

            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Re-initialize data on login attempt to get latest user list
            initializeData();
            
            const user = appState.users.find(u => 
                u.username === username && 
                u.password === password &&
                u.role === 'siswa' // HANYA cek siswa
            );

            setTimeout(() => { // Simulasi loading
                loginButtonText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');

                if (user) {
                    // Cek apakah siswa di-ban
                    if (localStorage.getItem('bannedUser_' + user.id) === 'true') {
                        appState.currentUser = user;
                        updateUserInfo();
                        showSection('ban');
                    } else {
                        appState.currentUser = user;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        updateUserInfo();
                        showSection('studentDashboard');
                        loadStudentDashboard();
                    }
                } else {
                    showAlert('loginAlert', 'Username atau password siswa salah.', 'danger');
                }
            }, 1000);
        });

        function logout() {
            appState.currentUser = null;
            localStorage.removeItem('currentUser');
            updateUserInfo();
            showSection('login');
        }

        document.getElementById('logoutBtn').addEventListener('click', logout);

        function updateUserInfo() {
            if (appState.currentUser) {
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                userName.textContent = appState.currentUser.fullName;
                userRole.textContent = 'Siswa'; // Selalu siswa
                userAvatar.innerHTML = appState.currentUser.fullName.charAt(0).toUpperCase();
            } else {
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
            }
        }

        // --- Student Dashboard ---

        function loadStudentDashboard() {
            if (!appState.currentUser) return;
            
            // Perbarui data dari localStorage jika ada perubahan
            initializeData();
            
            const studentResults = appState.results.filter(r => r.userId === appState.currentUser.id);
            const studentExams = appState.exams.filter(exam => 
                exam.assignedClasses.includes(appState.currentUser.classId)
            );
            
            document.getElementById('studentTotalExams').textContent = studentExams.length;
            document.getElementById('studentCompletedExams').textContent = studentResults.length;
            
            loadAvailableExams(studentExams);
            loadStudentHistory(studentResults);
        }

        function loadAvailableExams(studentExams) {
            const container = document.getElementById('availableExams');
            container.innerHTML = '';
            
            if (studentExams.length === 0) {
                container.innerHTML = `<p class="p-6 text-center text-gray-500">Tidak ada ujian yang tersedia untuk kelas Anda saat ini.</p>`;
                return;
            }
            
            studentExams.forEach(exam => {
                // Cek apakah ujian sudah dikerjakan
                const isCompleted = appState.results.some(r => r.userId === appState.currentUser.id && r.examId === exam.id);
                
                const examEl = document.createElement('div');
                examEl.className = 'p-4 sm:p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                examEl.innerHTML = `
                    <div class="mb-4 sm:mb-0">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-800">${exam.name}</h3>
                        <p class="text-gray-600 text-sm sm:text-base">${exam.subject} | ${exam.questions.length} Soal | ${exam.duration} Menit</p>
                    </div>
                    ${isCompleted ? 
                        `<button class="w-full sm:w-auto bg-green-600 text-white py-2 px-5 rounded-lg font-semibold flex items-center justify-center gap-2" disabled>
                            <i class="fas fa-check"></i> Selesai
                         </button>` :
                        `<button class="start-exam-btn w-full sm:w-auto bg-gray-900 hover:bg-gray-700 text-white py-2 px-5 rounded-lg font-semibold transition duration-200 flex items-center justify-center gap-2" data-id="${exam.id}">
                            <i class="fas fa-play"></i> Mulai Ujian
                         </button>`
                    }
                `;
                container.appendChild(examEl);
            });
            
            document.querySelectorAll('.start-exam-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const examId = parseInt(e.currentTarget.getAttribute('data-id'));
                    if (confirm('Apakah Anda yakin ingin memulai ujian? Waktu akan langsung dihitung.')) {
                        startExam(examId);
                    }
                });
            });
        }

        function loadStudentHistory(studentResults) {
            const tableBody = document.getElementById('studentHistoryTableBody');
            tableBody.innerHTML = '';
            
            if (studentResults.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-gray-500">Tidak ada riwayat ujian.</td></tr>`;
                return;
            }
            
            studentResults.forEach(result => {
                const exam = appState.exams.find(e => e.id === result.examId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-3 sm:p-4">${exam ? exam.name : 'Ujian Dihapus'}</td>
                    <td class="p-3 sm:p-4">${new Date(result.date).toLocaleString('id-ID')}</td>
                    <td class="p-3 sm:p-4">
                        <span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">${result.status}</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- Exam Process ---

        function startExam(examId) {
            const exam = appState.exams.find(e => e.id === examId);
            if (!exam) return;
            
            appState.currentExam = exam;
            appState.currentQuestion = 0;
            appState.examAnswers = {};
            appState.violations = 0;
            appState.examStartTime = new Date();
            
            loadExamUI(exam);
            setupAntiCheating();
            
            showSection('exam');
            loadQuestion(0);
        }

        function loadExamUI(exam) {
            document.getElementById('examTitle').textContent = exam.name;
            document.getElementById('examSubtitle').textContent = exam.subject;
            
            let timeRemaining = exam.duration * 60;
            updateTimerDisplay(timeRemaining);
            
            appState.examTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay(timeRemaining);
                if (timeRemaining <= 0) {
                    submitExam(true); // Auto-submit
                }
            }, 1000);
            
            generateQuestionNavigation(exam.questions.length);
        }

        function updateTimerDisplay(seconds) {
            document.getElementById('timerDisplay').textContent = formatTime(seconds);
        }

        function generateQuestionNavigation(questionCount) {
            const navigation = document.getElementById('questionNavigation');
            navigation.innerHTML = '';
            for (let i = 0; i < questionCount; i++) {
                const navBtn = document.createElement('button');
                navBtn.className = 'nav-btn w-10 h-10 border border-gray-300 rounded-lg text-gray-700 font-semibold transition duration-200 hover:bg-gray-100';
                navBtn.textContent = i + 1;
                navBtn.addEventListener('click', () => {
                    saveCurrentAnswer();
                    loadQuestion(i);
                });
                navigation.appendChild(navBtn);
            }
        }

        function loadQuestion(qIndex) {
            const exam = appState.currentExam;
            const question = exam.questions[qIndex];
            
            document.getElementById('questionNumber').textContent = `Pertanyaan ${qIndex + 1}`;
            document.getElementById('questionPoints').textContent = `${question.points} poin`;
            document.getElementById('questionText').innerHTML = question.question; // Use innerHTML to render formatted text if any
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionId = `option_${qIndex}_${index}`;
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-item border border-gray-300 rounded-lg p-4 flex items-center gap-4 cursor-pointer hover:bg-gray-100 transition duration-200';
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = optionId;
                input.name = `answer_${qIndex}`;
                input.value = index;
                input.className = 'w-5 h-5 text-gray-800 focus:ring-gray-700';
                
                if (appState.examAnswers[qIndex] === index) {
                    input.checked = true;
                    optionDiv.classList.add('bg-gray-100', 'border-gray-800');
                }
                
                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.textContent = option;
                label.className = 'flex-1 text-gray-800 cursor-pointer';
                
                optionDiv.appendChild(input);
                optionDiv.appendChild(label);
                
                optionDiv.addEventListener('click', () => {
                    input.checked = true;
                    document.querySelectorAll(`.option-item`).forEach(el => el.classList.remove('bg-gray-100', 'border-gray-800'));
                    optionDiv.classList.add('bg-gray-100', 'border-gray-800');
                    saveCurrentAnswer(); // Simpan langsung saat diklik
                });
                
                optionsContainer.appendChild(optionDiv);
            });
            
            appState.currentQuestion = qIndex;
            updateNavigationButtons(qIndex, exam.questions.length);
            updateNavBtnUI(qIndex);
        }

        function saveCurrentAnswer() {
            const qIndex = appState.currentQuestion;
            const selectedOption = document.querySelector(`input[name="answer_${qIndex}"]:checked`);
            
            // Tandai tombol navigasi jika sudah dijawab
            const navBtns = document.querySelectorAll('.nav-btn');
            const currentNavBtn = navBtns[qIndex];

            if (selectedOption) {
                appState.examAnswers[qIndex] = parseInt(selectedOption.value);
                if (currentNavBtn) currentNavBtn.classList.add('bg-gray-800', 'text-white');
            } else {
                // Jika jawaban dihapus (meski radio button sulit dihapus)
                delete appState.examAnswers[qIndex];
                if (currentNavBtn) currentNavBtn.classList.remove('bg-gray-800', 'text-white');
            }
        }

        function updateNavigationButtons(currentIndex, totalQuestions) {
            const prevBtn = document.getElementById('prevQuestionBtn');
            const nextBtn = document.getElementById('nextQuestionBtn');
            const submitBtn = document.getElementById('submitExamBtn');
            
            prevBtn.disabled = currentIndex === 0;
            if (prevBtn.disabled) {
                prevBtn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
                prevBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300'); // Hapus style hover/aktif
            } else {
                prevBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                prevBtn.classList.add('bg-gray-200', 'hover:bg-gray-300'); // Tambah style non-disabled
            }
            
            if (currentIndex === totalQuestions - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'inline-flex';
                submitBtn.style.display = 'none';
            }
        }

        function updateNavBtnUI(qIndex) {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach((btn, index) => {
                btn.classList.toggle('border-2', index === qIndex);
                btn.classList.toggle('border-gray-900', index === qIndex);
            });
        }

        document.getElementById('prevQuestionBtn').addEventListener('click', () => {
            saveCurrentAnswer();
            loadQuestion(appState.currentQuestion - 1);
        });

        document.getElementById('nextQuestionBtn').addEventListener('click', () => {
            saveCurrentAnswer();
            loadQuestion(appState.currentQuestion + 1);
        });

        document.getElementById('submitExamBtn').addEventListener('click', () => {
            saveCurrentAnswer();
            confirmSubmitModal.classList.remove('hidden');
        });

        document.getElementById('cancelSubmitBtn').addEventListener('click', () => {
            confirmSubmitModal.classList.add('hidden');
        });
        
        document.getElementById('confirmSubmitBtn').addEventListener('click', () => {
            submitExam(false);
            confirmSubmitModal.classList.add('hidden');
        });

        function submitExam(isAutoSubmit = false) {
            if (!isAutoSubmit) saveCurrentAnswer();
            
            clearInterval(appState.examTimer);
            removeAntiCheating();
            
            const results = calculateResults();
            
            const newResult = {
                id: appState.results.length > 0 ? Math.max(...appState.results.map(r => r.id)) + 1 : 1,
                userId: appState.currentUser.id,
                examId: appState.currentExam.id,
                date: new Date().toISOString(),
                score: results.percentage,
                status: 'Selesai', // Tidak ada status Lulus/Tidak Lulus di sisi siswa
                answers: appState.examAnswers,
                violations: appState.violations
            };
            
            appState.results.push(newResult);
            saveResultsToStorage();
            
            // Tampilkan halaman selesai, BUKAN halaman nilai
            showSection('examFinished');
        }

        function calculateResults() {
            const exam = appState.currentExam;
            let totalPoints = 0;
            let earnedPoints = 0;
            
            exam.questions.forEach((question, index) => {
                totalPoints += question.points;
                if (appState.examAnswers[index] === question.correctAnswer) {
                    earnedPoints += question.points;
                }
            });
            
            const percentage = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
            
            return {
                percentage,
                earnedPoints,
                totalPoints
            };
        }

        // --- Halaman Selesai ---
        document.getElementById('backToDashboardBtn').addEventListener('click', () => {
            showSection('studentDashboard');
            loadStudentDashboard();
        });

        // --- Anti-Cheating ---

        function setupAntiCheating() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('keydown', handleKeyDown);
        }

        function removeAntiCheating() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleWindowBlur);
            document.removeEventListener('contextmenu', handleContextMenu);
            document.removeEventListener('keydown', handleKeyDown);
        }

        function handleVisibilityChange() {
            if (document.hidden && sections.exam.classList.contains('active')) {
                handleViolation('Beralih tab atau aplikasi');
            }
        }

        function handleWindowBlur() {
            if (sections.exam.classList.contains('active')) {
                // Diberi jeda singkat untuk menangani false positive
                setTimeout(() => {
                    if (document.activeElement.tagName.toLowerCase() !== 'iframe') {
                         handleViolation('Jendela ujian kehilangan fokus');
                    }
                }, 300);
            }
        }
        
        function handleContextMenu(e) {
            if (sections.exam.classList.contains('active')) {
                e.preventDefault();
                handleViolation('Mencoba klik kanan');
            }
        }
        
        function handleKeyDown(e) {
             if (!sections.exam.classList.contains('active')) return;
             
             // F12, Ctrl+Shift+I/J/C, Ctrl+U
             if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) || (e.ctrlKey && e.key.toUpperCase() === 'U')) {
                 e.preventDefault();
                 handleViolation('Mencoba membuka developer tools');
             }
             // Alt+Tab, Meta Key (Windows/Cmd)
             if ((e.altKey && e.key === 'Tab') || e.metaKey) {
                 e.preventDefault();
                 handleViolation('Mencoba beralih aplikasi');
             }
        }

        let violationTimeout;
        function handleViolation(reason) {
            if (!sections.exam.classList.contains('active')) return;
            
            // Mencegah trigger ganda
            if (violationWarning.classList.contains('hidden')) {
                appState.violations++;
                
                document.getElementById('violationReason').textContent = reason + '.';
                document.getElementById('violationCount').textContent = appState.violations;
                violationWarning.classList.remove('hidden');

                if (appState.violations >= 3) {
                    // Ban user
                    banUser();
                }

                // Sembunyikan peringatan setelah beberapa detik
                clearTimeout(violationTimeout);
                violationTimeout = setTimeout(() => {
                    violationWarning.classList.add('hidden');
                }, 4000);
            }
        }

        function banUser() {
            localStorage.setItem('bannedUser_' + appState.currentUser.id, 'true');
            clearInterval(appState.examTimer);
            removeAntiCheating();
            showSection('ban');
        }

        // --- Ban Section ---
        document.getElementById('unlockForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const unlockCode = document.getElementById('unlockCode').value;
            
            // Kode demo
            if (unlockCode === 'UNLOCK123') {
                localStorage.removeItem('bannedUser_' + appState.currentUser.id);
                appState.violations = 0;
                showAlert('banAlert', 'Blokir akun dibuka. Anda akan dikembalikan ke dashboard.', 'success');
                setTimeout(() => {
                    showSection('studentDashboard');
                    loadStudentDashboard();
                }, 3000);
            } else {
                showAlert('banAlert', 'Kode token salah.', 'danger');
            }
        });
        
    </script>
</body>
</html>
